<div class="layout">
  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–¥–∞—á - –ü–ï–†–í–´–ô –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö -->
  <main class="tasks-main">
    <app-task-list></app-task-list>
  </main>

  <!-- Sidebar —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π - –í–¢–û–†–û–ô –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö -->
  <aside class="sidebar">
    <div class="sidebar-section">
      <h4>üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>

      <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ—Å—è—Ü–∞ -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-content">
            <div class="stat-value">{{ monthlyStats?.completedTasks || 0 }}</div>
            <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üìù</div>
          <div class="stat-content">
            <div class="stat-value">{{ monthlyStats?.totalTasks || 0 }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">‚ö°</div>
          <div class="stat-content">
            <div class="stat-value">{{ monthlyStats?.productivity || 0 }}%</div>
            <div class="stat-label">–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üìÖ</div>
          <div class="stat-content">
            <div class="stat-value">{{ monthlyStats?.pendingTasks || 0 }}</div>
            <div class="stat-label">–í –æ–∂–∏–¥–∞–Ω–∏–∏</div>
          </div>
        </div>
      </div>

      <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
      <div class="progress-container">
        <div class="progress-header">
          <span>–ü—Ä–æ–≥—Ä–µ—Å—Å –º–µ—Å—è—Ü–∞</span>
          <span class="progress-percent">{{ monthlyStats?.productivity || 0 }}%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="monthlyStats?.productivity || 0"></div>
        </div>
        <div class="progress-details">
          <span>{{ monthlyStats?.completedTasks || 0 }}/{{ monthlyStats?.totalTasks || 0 }} –∑–∞–¥–∞—á</span>
        </div>
      </div>

      <!-- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∑–∞–¥–∞—á -->
      <div class="priority-stats">
        <h5>üìà –ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º</h5>
        <div class="priority-item">
          <span class="priority-badge high">–í—ã—Å–æ–∫–∏–π</span>
          <span class="priority-count">{{ priorityStats?.high || 0 }}</span>
        </div>
        <div class="priority-item">
          <span class="priority-badge medium">–°—Ä–µ–¥–Ω–∏–π</span>
          <span class="priority-count">{{ priorityStats?.medium || 0 }}</span>
        </div>
        <div class="priority-item">
          <span class="priority-badge low">–ù–∏–∑–∫–∏–π</span>
          <span class="priority-count">{{ priorityStats?.low || 0 }}</span>
        </div>
      </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å -->
    <div class="sidebar-section">
      <div class="today-stats">
        <h4>üéØ {{ isToday ? '–°–µ–≥–æ–¥–Ω—è' : formattedDate }}</h4>
        <div class="today-grid">
          <div class="today-item">
            <div class="today-value">{{ completedTasksCount }}</div>
            <div class="today-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
          </div>
          <div class="today-item">
            <div class="today-value">{{ completedTasksCount }}</div>
            <div class="today-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
          </div>
          <div class="today-item">
            <div class="today-value">{{ completedTasksCount }}</div>
            <div class="today-label">–û—Å—Ç–∞–ª–æ—Å—å</div>
          </div>
        </div>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–Ω—è -->
        <div class="daily-progress" *ngIf="currentDateTasks.length > 0">
          <div class="progress-mini">
            <div class="progress-fill-mini"
                 [style.width.%]="completionPercentage">
            </div>
          </div>
          <span class="daily-percent">
            {{ completionPercentage }}% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
          </span>
        </div>
        <div class="daily-progress" *ngIf="currentDateTasks.length === 0">
          <span class="daily-percent">–ù–µ—Ç –∑–∞–¥–∞—á –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</span>
        </div>
      </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="sidebar-section">
      <div class="quick-actions">
        <h4>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h4>
        <button class="quick-btn" (click)="toggleInvitePopup()">
          üîë –ò–Ω–≤–∞–π—Ç-–∫–æ–¥—ã
        </button>
        <button class="quick-btn warning" (click)="resetMyTasks()" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–æ–∏ –∑–∞–¥–∞—á–∏">
          üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –º–æ–∏ –∑–∞–¥–∞—á–∏
        </button>
        <button *ngIf="isAdmin" class="quick-btn admin" (click)="toggleAdminPanel()">
          üõ†Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
        </button>
        <button *ngIf="isAdmin" class="quick-btn danger" (click)="resetAllTasks()" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">
          ‚ö†Ô∏è –°–±—Ä–æ—Å–∏—Ç—å –í–°–ï –∑–∞–¥–∞—á–∏
        </button>
      </div>
    </div>

    <!-- –ê–¥–º–∏–Ω—Å–∫–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="sidebar-section" *ngIf="showAdminPanel && isAdmin">
      <div class="admin-panel">
        <h4>üõ†Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h4>

        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–¥–∞ –∞–¥–º–∏–Ω–æ–º -->
        <div class="admin-code-creation">
          <h5>–°–æ–∑–¥–∞—Ç—å –∫–æ–¥ –≤—Ä—É—á–Ω—É—é</h5>
          <div class="admin-form">
            <input
              type="text"
              [(ngModel)]="newCodeInput"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: NEWCODE123)"
              class="form-control"
            >
            <button
              class="btn-admin"
              (click)="generateAdminCode()"
              [disabled]="!newCodeInput.trim() || isGeneratingCode"
            >
              {{ isGeneratingCode ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : '–°–æ–∑–¥–∞—Ç—å –∫–æ–¥' }}
            </button>
          </div>
        </div>

        <div class="admin-actions">
          <button class="btn-admin-warning" (click)="resetAllCodes()">
            üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∫–æ–¥—ã
          </button>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–¥–æ–≤ -->
        <div class="codes-stats">
          <p><strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–¥–æ–≤:</strong></p>
          <p>–í—Å–µ–≥–æ: {{ allCodes.length }} | –î–æ—Å—Ç—É–ø–Ω–æ: {{ availableCodes.length }} | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {{ usedCodes.length }}</p>
        </div>

        <!-- –í—Å–µ –∫–æ–¥—ã –¥–ª—è –∞–¥–º–∏–Ω–∞ -->
        <div class="admin-codes-section">
          <h5>–í—Å–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥—ã ({{ allCodes.length }})</h5>
          <div class="codes-list">
            <div *ngFor="let code of allCodes" class="code-item" [class.used]="code.used">
              <div class="code-info">
                <span class="code-value">{{ code.code }}</span>
                <div class="code-details">
                  <span class="code-status" [class.used]="code.used">
                    {{ code.used ? '‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω' : 'üü¢ –î–æ—Å—Ç—É–ø–µ–Ω' }}
                  </span>
                  <span class="code-date">
                    –°–æ–∑–¥–∞–Ω: {{ code.createdAt | date:'dd.MM.yyyy' }}
                    <span *ngIf="code.used && code.usedAt">
                      | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: {{ code.usedAt | date:'dd.MM.yyyy' }}
                    </span>
                  </span>
                </div>
              </div>
              <div class="code-actions">
                <button
                  class="copy-btn"
                  (click)="copyToClipboard(code.code)"
                  title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
                >
                  üìã
                </button>
                <button
                  *ngIf="!code.used"
                  class="delete-btn"
                  (click)="deleteInviteCode(code.code)"
                  title="–£–¥–∞–ª–∏—Ç—å"
                >
                  üóëÔ∏è
                </button>
              </div>
            </div>
            <div *ngIf="allCodes.length === 0" class="no-codes">
              –ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤
            </div>
          </div>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- –ü–æ–ø–∞–ø –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–æ–≤ -->
<div *ngIf="showInvitePopup" class="popup-overlay" (click)="toggleInvitePopup()">
  <div class="popup-content" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <h3>üîë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞–º–∏</h3>
      <button class="close-btn" (click)="toggleInvitePopup()">√ó</button>
    </div>

    <div class="popup-body">
      <!-- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞ -->
      <div class="invite-section">
        <h4>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥</h4>
        <p class="text-sm">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∏–Ω–≤–∞–π—Ç-–∫–æ–¥ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
        <button class="btn-primary" (click)="generateInviteCode()" [disabled]="isLoading">
          {{ isLoading ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : 'üéÅ –°–æ–∑–¥–∞—Ç—å –∏–Ω–≤–∞–π—Ç-–∫–æ–¥' }}
        </button>

        <div *ngIf="newInviteCode" class="new-code-section">
          <p class="text-sm"><strong>–ù–æ–≤—ã–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω!</strong> –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ:</p>
          <div class="code-display">
            {{ newInviteCode }}
            <button class="copy-btn" (click)="copyToClipboard(newInviteCode)">üìã</button>
          </div>
        </div>
      </div>

      <!-- –ú–æ–∏ –∫–æ–¥—ã -->
      <div class="invite-section">
        <h4>–ú–æ–∏ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥—ã ({{ userCodes.length }})</h4>
        <div class="codes-list">
          <div *ngFor="let code of userCodes" class="code-item" [class.used]="code.used">
            <div class="code-info">
              <span class="code-value">{{ code.code }}</span>
              <div class="code-details">
                <span class="code-status" [class.used]="code.used">
                  {{ code.used ? '‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω' : 'üü¢ –î–æ—Å—Ç—É–ø–µ–Ω' }}
                </span>
                <span class="code-date">
                  –°–æ–∑–¥–∞–Ω: {{ code.createdAt | date:'dd.MM.yyyy' }}
                </span>
              </div>
            </div>
            <div class="code-actions">
              <button
                class="copy-btn"
                (click)="copyToClipboard(code.code)"
                title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
              >
                üìã
              </button>
            </div>
          </div>
          <div *ngIf="userCodes.length === 0" class="no-codes">
            –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤
          </div>
        </div>
      </div>

      <!-- –ê–¥–º–∏–Ω—Å–∫–∞—è —Å–µ–∫—Ü–∏—è –≤ –ø–æ–ø–∞–ø–µ -->
      <div class="invite-section" *ngIf="isAdmin">
        <h4>üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–æ–≤</h4>
        <div class="codes-stats">
          <p><strong>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong></p>
          <p>–í—Å–µ–≥–æ –∫–æ–¥–æ–≤: {{ allCodes.length }} | –î–æ—Å—Ç—É–ø–Ω–æ: {{ availableCodes.length }} | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {{ usedCodes.length }}</p>
        </div>

        <div class="admin-actions">
          <button class="btn-admin-warning" (click)="resetAllCodes()">
            üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∫–æ–¥—ã
          </button>
          <button class="btn-admin-danger" (click)="resetAllTasks()" style="margin-top: 8px;">
            ‚ö†Ô∏è –°–±—Ä–æ—Å–∏—Ç—å –í–°–ï –∑–∞–¥–∞—á–∏
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="app-container">
  <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
  <div *ngIf="!isAuthenticated" class="auth-container">
    <!-- Router outlet –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü –ª–æ–≥–∏–Ω–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <router-outlet></router-outlet>
  </div>

  <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
  <div *ngIf="isAuthenticated" class="app-layout">
    <!-- –®–∞–ø–∫–∞ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π - –ü–û–ö–ê–ó–´–í–ê–ï–ú –¢–û–õ–¨–ö–û –ö–û–ì–î–ê showHeader = true -->
    <header class="header" *ngIf="showHeader">
      <div class="header-content">
        <div class="date-navigation">
          <button class="nav-btn" (click)="previousDay()" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å">
            ‚Üê
          </button>

          <button class="nav-btn today-btn" (click)="setToday()" [class.active]="isToday">
            –°–µ–≥–æ–¥–Ω—è
          </button>

          <button class="nav-btn" (click)="nextDay()" title="–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å">
            ‚Üí
          </button>

          <div class="current-date">
            {{ formattedDate }}
          </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å —à–∞–ø–∫–∏ -->
        <div class="header-right">
          <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —à–∞–ø–∫–µ -->
          <div class="header-stats">
            <div class="stat-item">
              <span class="stat-value">{{ monthlyStats?.completedTasks || 0 }}</span>
              <span class="stat-label">/{{ monthlyStats?.totalTasks || 0 }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">{{ monthlyStats?.productivity || 0 }}%</span>
              <span class="stat-label">–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
            </div>
          </div>

          <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
          <div class="user-info" *ngIf="currentUser">
            <div class="user-details">
              <div class="user-name-row">
                <span class="user-name">{{ currentUser.name }}</span>
                <span *ngIf="isAdmin" class="admin-badge">ADMIN</span>
              </div>
              <span class="user-email">{{ currentUser.email }}</span>
            </div>
            <div class="user-actions">
              <button class="invite-btn" (click)="toggleInvitePopup()" title="–ò–Ω–≤–∞–π—Ç-–∫–æ–¥—ã">
                üîë
              </button>
              <button class="logout-btn" (click)="logout()" title="–í—ã–π—Ç–∏">
                üö™
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ —Ä–æ—É—Ç–µ—Ä -->
    <main class="main-content">
      <router-outlet></router-outlet>
    </main>
  </div>
</div>

<!-- –ü–æ–ø–∞–ø –¥–ª—è –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–æ–≤ -->
<div *ngIf="showInvitePopup" class="invite-popup-overlay" (click)="toggleInvitePopup()">
  <div class="invite-popup" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞–º–∏</h3>
      <button class="close-btn" (click)="toggleInvitePopup()">√ó</button>
    </div>

    <div class="popup-content">
      <!-- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞ -->
      <div class="invite-section">
        <h4>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥</h4>
        <p class="text-sm">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∏–Ω–≤–∞–π—Ç-–∫–æ–¥ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
        <button
          class="btn-primary"
          (click)="generateInviteCode()"
          [disabled]="isLoading"
        >
          {{ isLoading ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : '–°–æ–∑–¥–∞—Ç—å –∏–Ω–≤–∞–π—Ç-–∫–æ–¥' }}
        </button>

        <div *ngIf="newInviteCode" class="new-code-section">
          <p class="text-sm"><strong>–ù–æ–≤—ã–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω!</strong> –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ:</p>
          <div class="code-display">
            {{ newInviteCode }}
          </div>
          <button class="btn-primary" (click)="copyToClipboard(newInviteCode)">
            üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
          </button>
        </div>
      </div>

      <!-- –ú–æ–∏ –∫–æ–¥—ã -->
      <div class="invite-section">
        <h4>–ú–æ–∏ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥—ã ({{ userCodes.length }})</h4>
        <div class="codes-list">
          <div *ngFor="let code of userCodes" class="code-item" [class.used]="code.used">
            <div class="code-info">
              <span class="code-value">{{ code.code }}</span>
              <div class="code-details">
                <span class="code-status" [class.used]="code.used">
                  {{ code.used ? '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω' : '–î–æ—Å—Ç—É–ø–µ–Ω' }}
                </span>
                <span class="code-date">
                  –°–æ–∑–¥–∞–Ω: {{ code.createdAt | date:'dd.MM.yyyy' }}
                </span>
              </div>
            </div>
            <div class="code-actions">
              <button
                class="copy-btn"
                (click)="copyToClipboard(code.code)"
                title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
              >
                üìã
              </button>
            </div>
          </div>
          <div *ngIf="userCodes.length === 0" class="no-codes-message">
            –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤
          </div>
        </div>
      </div>

      <!-- –ê–¥–º–∏–Ω—Å–∫–∞—è —Å–µ–∫—Ü–∏—è -->
      <div class="invite-section" *ngIf="isAdmin">
        <h4>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–æ–≤</h4>
        <div class="codes-stats">
          <p>–í—Å–µ–≥–æ –∫–æ–¥–æ–≤: {{ allCodes.length }} | –î–æ—Å—Ç—É–ø–Ω–æ: {{ availableCodes.length }} | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {{ usedCodes.length }}</p>
        </div>

        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–¥–∞ –∞–¥–º–∏–Ω–æ–º -->
        <div class="admin-code-creation">
          <h5>–°–æ–∑–¥–∞—Ç—å –∫–æ–¥ –≤—Ä—É—á–Ω—É—é</h5>
          <div class="admin-form">
            <input
              type="text"
              [(ngModel)]="newCodeInput"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: NEWCODE123)"
              class="form-control"
            >
            <button
              class="btn-admin"
              (click)="generateAdminCode()"
              [disabled]="!newCodeInput.trim() || isGeneratingCode"
            >
              {{ isGeneratingCode ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : '–°–æ–∑–¥–∞—Ç—å –∫–æ–¥' }}
            </button>
          </div>
        </div>

        <div class="admin-actions">
          <button class="btn-admin-warning" (click)="resetAllCodes()">
            –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∫–æ–¥—ã
          </button>
          <button class="btn-admin-warning" (click)="resetAllTasks()" style="margin-top: 8px; background: #d69e2e;">
            –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏
          </button>
        </div>

        <!-- –í—Å–µ –∫–æ–¥—ã –¥–ª—è –∞–¥–º–∏–Ω–∞ -->
        <div class="admin-codes-section">
          <h5>–í—Å–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥—ã ({{ allCodes.length }})</h5>
          <div class="codes-list">
            <div *ngFor="let code of allCodes" class="code-item" [class.used]="code.used">
              <div class="code-info">
                <span class="code-value">{{ code.code }}</span>
                <div class="code-details">
                  <span class="code-status" [class.used]="code.used">
                    {{ code.used ? '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω' : '–î–æ—Å—Ç—É–ø–µ–Ω' }}
                  </span>
                  <span class="code-date">
                    –°–æ–∑–¥–∞–Ω: {{ code.createdAt | date:'dd.MM.yyyy' }}
                    <span *ngIf="code.used && code.usedAt">
                      | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: {{ code.usedAt | date:'dd.MM.yyyy' }}
                    </span>
                  </span>
                </div>
              </div>
              <div class="code-actions">
                <button
                  class="copy-btn"
                  (click)="copyToClipboard(code.code)"
                  title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
                >
                  üìã
                </button>
                <button
                  *ngIf="!code.used"
                  class="delete-btn"
                  (click)="deleteInviteCode(code.code)"
                  title="–£–¥–∞–ª–∏—Ç—å"
                >
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
